# Claude Code + Secretive (SSH keys in Secure Enclave)
#
# For users who store SSH keys in macOS Secure Enclave via Secretive
# (https://github.com/maxgoedjen/secretive) and want git commit signing
# to work inside the nono sandbox.
#
# Install:
#   mkdir -p ~/.config/nono/profiles
#   cp data/profiles/claude-code-secretive.toml ~/.config/nono/profiles/
#
# Usage:
#   nono run --profile claude-code-secretive --allow-cwd -- claude
#
# Prerequisite:
#   Disable Claude Code's built-in sandbox so nono is the sole enforcer.

interactive = true

[meta]
name = "claude-code-secretive"
version = "1.0.0"
description = "Claude Code with Secretive SSH agent (Secure Enclave signing)"
author = "community"

[workdir]
access = "readwrite"

[filesystem]
allow = [
    # Claude Code state (debug logs, projects, settings)
    "$HOME/.claude",

    # git signing creates temp buffers in $TMPDIR (e.g. .git_signing_buffer_tmp*)
    "$TMPDIR",
]

read = [
    # Secretive public keys — git reads these for commit signing verification
    "$HOME/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys",
]

write = []

allow_file = [
    # Claude Code settings
    "$HOME/.claude.json",

    # SSH known_hosts — git/ssh may need to append new host keys
    "$HOME/.ssh/known_hosts",
]

read_file = [
    # macOS Keychain for Claude OAuth authentication
    "$HOME/Library/Keychains/login.keychain-db",

    # Git configuration (gpg.format = ssh, user.signingKey, etc.)
    "$HOME/.gitconfig",

    # SSH config (IdentityAgent pointing to Secretive socket)
    "$HOME/.ssh/config",

    # Secretive agent socket — a Unix domain socket, not a regular file.
    # Requires the socket capability fix (is_dir() check instead of is_file()).
    # Connecting uses (allow network-outbound) which nono grants by default.
    "$HOME/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh",

    # Global gitignore — git reads this during operations
    "$HOME/.gitignore",

    # allowed_signers for commit signature verification.
    # git may look in either location depending on gpg.ssh.allowedSignersFile config.
    "$HOME/.ssh/allowed_signers",
    "$HOME/.config/git/allowed_signers",
]

write_file = []

[network]
block = false

[secrets]

[hooks.claude-code]
event = "PostToolUseFailure"
matcher = "Read|Write|Edit|Bash"
script = "nono-hook.sh"
